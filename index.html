<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>VibeRoute ‚Äî –¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>

<body data-generated="{{ 1 if generated else 0 }}">
    <div class="header">
        <div class="logo">
            VibeRoute
        </div>
        <div class="desc">–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π AI</div>
        <div class="header-btns">
            <button
                onclick="alert('VibeRoute ‚Äî —Å–µ—Ä–≤–∏—Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—É–ª–æ–∫ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é, –±—é–¥–∂–µ—Ç—É –∏ –≤—Ä–µ–º–µ–Ω–∏. Powered by AI.')">–û
                –ø—Ä–æ–µ–∫—Ç–µ</button>
        </div>
    </div>
    <form id="mainform" method="post" style="margin:0;padding:0;">
        <div class="container">
            <div class="leftcol">
                <div class="params">
                    <div class="param-block route-pts">
                        <label for="start_addr">–û—Ç–∫—É–¥–∞ –Ω–∞—á–∞—Ç—å?</label>
                        <div style="display:flex;gap:10px;margin-bottom:6px;">
                            <input type="text" id="start_addr" name="start_addr" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..."
                                style="flex:1;" value="{{ formdata.start_addr|default('')}}">
                            <button type="button" onclick="geoLocateStart()" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é"
                                style="border:none;background:none;cursor:pointer;font-size:1.35rem;">üìç</button>
                        </div>
                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
                        <input type="hidden" id="start_lat" name="start_lat" value="{{ formdata.start_lat|default('')}}">
                        <input type="hidden" id="start_lng" name="start_lng" value="{{ formdata.start_lng|default('')}}">

                        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã -->
                        <input type="hidden" id="map_lat" name="map_lat" value="{{ formdata.map_lat|default('')}}">
                        <input type="hidden" id="map_lng" name="map_lng" value="{{ formdata.map_lng|default('')}}">
                        <input type="hidden" id="map_zoom" name="map_zoom" value="{{ formdata.map_zoom|default('')}}">

                        <label for="end_addr" style="margin-top:16px;">–ö—É–¥–∞ —Ö–æ—á–µ—à—å –ø—Ä–∏–π—Ç–∏?</label>
                        <div style="display:flex;gap:10px;margin-bottom:6px;">
                            <input type="text" id="end_addr" name="end_addr" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..."
                                style="flex:1;" value="{{ formdata.end_addr|default('')}}">

                            <button type="button" onclick="geoLocateEnd()" title="–£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É –ø–æ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏"
                                style="border:none;background:none;cursor:pointer;font-size:1.35rem;">
                                üìç
                            </button>
                        </div>
                        <input type="hidden" id="end_lat" name="end_lat" value="{{ formdata.end_lat|default('')}}">
                        <input type="hidden" id="end_lng" name="end_lng" value="{{ formdata.end_lng|default('')}}">

                    </div>
                    <div class="param-block walk-details">
                        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≥—É–ª–∫–∏</label>
                        <div class="flex gap budget-row" style="margin-top:5px;align-items:center;">
                            <input type="range" min="60" max="480" step="15"
                                value="{{ formdata.duration_hrs|default(2)*60 + formdata.duration_mins|default(0) }}"
                                id="duration_slider" style="flex:1;" oninput="updateDurationLabel(this.value)">
                            <span class="slider-label" style="width:90px;">
                                <span id="durationLabel">{{ formdata.duration_hrs|default(2) }} —á {{
                                    formdata.duration_mins|default(0) }} –º–∏–Ω</span>
                            </span>
                            <input type="hidden" name="duration_hrs" id="duration_hrs">
                            <input type="hidden" name="duration_mins" id="duration_mins">
                        </div>


                        <label style="margin-top:17px;">–ë—é–¥–∂–µ—Ç –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞ <span
                                style="font-size:0.98em;color:#aaa;">(‚ÇΩ)</span></label>
                        <div class="flex gap budget-row" style="margin-top:5px;align-items:center;">
                            <input type="range" min="500" max="10000" step="100"
                                value="{{ formdata.budget|default(2000) }}" id="budget_slider" style="width:110px;"
                                onchange="budgetValInp.value=this.value">
                            <span class="slider-label"><input type="number" name="budget" min="500" max="10000"
                                    step="100" id="budgetValInp" value="{{ formdata.budget|default(2000) }}"
                                    style="width:90px;" oninput="budget_slider.value=this.value"></span>
                            <button type="button" class="pres-budget" onclick="setBudget(1000)">–≠–∫–æ–Ω–æ–º</button>
                            <button type="button" class="pres-budget" onclick="setBudget(3000)">–°—Ä–µ–¥–Ω–∏–π</button>
                            <button type="button" class="pres-budget" onclick="setBudget(6000)">–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π</button>
                            <button type="button" class="pres-budget" onclick="setBudget(10000)">–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π</button>
                        </div>

                        <label style="margin-top:17px;">–•–∞—Ä–∞–∫—Ç–µ—Ä –ø—Ä–æ–≥—É–ª–∫–∏</label>
                        <div class="char-vibe-cards" id="vibe-cards">
                            {% for v in vibes %}
                            <div class="char-vibe-card {% if formdata.vibe==v[0] %}selected{% endif %}"
                                data-vibe="{{v[0]}}" onclick="selectVibe('{{v[0]}}')">
                                <span>{{v[1]}}</span> <span>{{v[2]}}</span>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="vibe" name="vibe" value="{{ formdata.vibe|default('romantic') }}">

                        <label style="margin-top:15px;">–°–≤–æ–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        <textarea name="extra_notes" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è..." style="width:100%;min-height:120px;resize:vertical;">{{ formdata.extra_notes|default('') }}</textarea>
                    </div>
                    <button class="btn-main" type="submit" id="submitBtn" {% if loading %}disabled{% endif %}>
                        {% if loading %}<span id="spinner">‚è≥</span> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...{% else %}–°–æ–∑–¥–∞—Ç—å –ú–∞—Ä—à—Ä—É—Ç{% endif %}
                    </button>
                </div>
            </div>
            <div class="rightcol">
                <div id="map" style="width:100%;height:700px;border-radius:14px;box-shadow:0 1px 8px #0002;"></div>
                <div style="font-size:.98em;color:#aaa;margin-top:10px;">* –ú–∞—Ä–∫–µ—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ –º–µ—Ä–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—á–µ–∫.
                    –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.</div>
            </div>
        </div>
    </form>
    {% if generated %}
    <div class="result-area" id="results">
        <h2 class="result-h">–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç!</h2>
        <div class="result-metrics">
            <div class="metric">
                <span class="metric-label">–¢–∏–ø –ø—Ä–æ–≥—É–ª–∫–∏</span>
                <span class="metric-val">{{ result_data.vibe_verbose }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                <span class="metric-val">{{ result_data.duration_str }}</span>
            </div>
            <div class="metric">
                <span class="metric-label">–ë—é–¥–∂–µ—Ç</span>
                <span class="metric-val">{{ result_data.budget }} ‚ÇΩ</span>
            </div>
        </div>
        <h3 style="margin:26px 0 9px 0;">–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –º–∞—Ä—à—Ä—É—Ç–∞</h3>
    </div>
    {% endif %}
    <script id="places-data" type="application/json">{{ places|tojson }}</script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine-openrouteservice/dist/leaflet-routing-openrouteservice.min.js"></script>

    <script>
        const durationSlider = document.getElementById('duration_slider');
        const durationLabel = document.getElementById('durationLabel');
        const durationHoursInput = document.getElementById('duration_hrs');
        const durationMinsInput = document.getElementById('duration_mins');

        function updateDurationLabel(value) {
            const hours = Math.floor(value / 60);
            const mins = value % 60;
            durationLabel.textContent = `${hours} —á ${mins} –º–∏–Ω`;
            durationHoursInput.value = hours;
            durationMinsInput.value = mins;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateDurationLabel(durationSlider.value);
        function setBudget(v) { budget_slider.value = budgetValInp.value = v; }
        function selectVibe(val) {
            document.getElementById('vibe').value = val;
            document.querySelectorAll('.char-vibe-card').forEach(
                c => { c.classList.remove('selected'); if (c.getAttribute('data-vibe') === val) c.classList.add('selected'); });
        }
        document.getElementById('mainform').addEventListener('submit', function (e) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—Ç—Ä –∏ –∑—É–º –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ POST –æ–Ω–∞ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∞—Å—å –Ω–∞ –ú–æ—Å–∫–≤—É
            if (map) {
                const c = map.getCenter();
                const latField = document.getElementById('map_lat');
                const lngField = document.getElementById('map_lng');
                const zoomField = document.getElementById('map_zoom');
                if (latField) latField.value = c.lat;
                if (lngField) lngField.value = c.lng;
                if (zoomField) zoomField.value = map.getZoom();
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
            if (currentLocationCoords) {
                const latField = document.getElementById('start_lat');
                const lngField = document.getElementById('start_lng');
                if (latField) latField.value = currentLocationCoords.lat;
                if (lngField) lngField.value = currentLocationCoords.lng;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –ö–û–ù–ï–ß–ù–û–ô —Ç–æ—á–∫–∏
            if (endLocationCoords) {
                const latField = document.getElementById('end_lat');
                const lngField = document.getElementById('end_lng');
                if (latField) latField.value = endLocationCoords.lat;
                if (lngField) lngField.value = endLocationCoords.lng;
            }

        });

        // --- Interactive Map with Leaflet ---
        const mapLatField = document.getElementById('map_lat');
        const mapLngField = document.getElementById('map_lng');
        const mapZoomField = document.getElementById('map_zoom');

        const initialLat = parseFloat(mapLatField && mapLatField.value) || 55.751244;
        const initialLng = parseFloat(mapLngField && mapLngField.value) || 37.618423;
        const initialZoom = parseInt(mapZoomField && mapZoomField.value) || 12;

        let map = L.map('map').setView([initialLat, initialLng], initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        const IS_GENERATED = (document.body && document.body.dataset && document.body.dataset.generated === '1');
        let PLACES = [];
        try {
            const placesEl = document.getElementById('places-data');
            if (placesEl && placesEl.textContent) {
                PLACES = JSON.parse(placesEl.textContent);
            }
        } catch (e) {
            PLACES = [];
        }

        let markers = [];
        let currentLocationCoords = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        let currentLocationMarker = null;
        let endLocationMarker = null;
        let endLocationCoords = null;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à –ø–æ—Å–ª–µ POST –∏–∑ hidden-–ø–æ–ª–µ–π
        const startLatHidden = parseFloat(document.getElementById('start_lat')?.value || '');
        const startLngHidden = parseFloat(document.getElementById('start_lng')?.value || '');
        if (Number.isFinite(startLatHidden) && Number.isFinite(startLngHidden)) {
            currentLocationCoords = { lat: startLatHidden, lng: startLngHidden };
        }

        const endLatHidden = parseFloat(document.getElementById('end_lat')?.value || '');
        const endLngHidden = parseFloat(document.getElementById('end_lng')?.value || '');
        if (Number.isFinite(endLatHidden) && Number.isFinite(endLngHidden)) {
            endLocationCoords = { lat: endLatHidden, lng: endLngHidden };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        function updateAddressFromCoords(lat, lng, marker) {
            fetch('/reverse_geocode?lat=' + lat + '&lng=' + lng)
                .then(r => r.json())
                .then(res => {
                    const inp = document.getElementById('start_addr');
                    if (inp) {
                        inp.value = res.address || '';
                    }
                    if (marker) {
                        marker.setTooltipContent('–°—Ç–∞—Ä—Ç: ' + (res.address || ''));
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    currentLocationCoords = { lat: lat, lng: lng };
                })
                .catch(() => {
                    const inp = document.getElementById('start_addr');
                    if (inp) {
                        inp.value = `${lat}, ${lng}`;
                    }
                    if (marker) {
                        marker.setTooltipContent('–°—Ç–∞—Ä—Ç: ' + `${lat}, ${lng}`);
                    }
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ü–≤–µ—Ç–Ω–æ–π –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–∞
        function createColoredIcon(color, type) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; width: 25px; height: 25px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 25],
                popupAnchor: [0, -25]
            });
        }

        let placeMarkers = [];

        function clearPlaceMarkers() {
            placeMarkers.forEach(m => {
                try { map.removeLayer(m); } catch { }
            });
            placeMarkers = [];
        }

        function addPlaceMarkersIfGenerated() {
            if (!IS_GENERATED) return;
            if (!Array.isArray(PLACES) || PLACES.length === 0) return;

            clearPlaceMarkers();

            PLACES.forEach((feat) => {
                const coords = feat?.geometry?.coordinates;
                if (!Array.isArray(coords) || coords.length < 2) return;
                const lng = parseFloat(coords[0]);
                const lat = parseFloat(coords[1]);
                if (![lat, lng].every(n => Number.isFinite(n))) return;

                const props = feat?.properties || {};
                const name = (props.name || props['name:ru'] || props['name:en'] || '–ú–µ—Å—Ç–æ');
                const amenity = (props.amenity || '');

                const m = L.marker([lat, lng], {
                    icon: createColoredIcon('#5797f8', 'place')
                }).addTo(map);
                m.bindPopup(`<b>${String(name)}</b>${amenity ? `<br><span style="color:#666">${String(amenity)}</span>` : ''}`);
                placeMarkers.push(m);
            });
        }

        // Geolocation for start
        function geoLocateStart() {
            console.log('geoLocateStart –≤—ã–∑–≤–∞–Ω–∞');
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º.');
                return;
            }
            if (!map) {
                alert('–ö–∞—Ä—Ç–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                return;
            }
            console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é...');
            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    console.log('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:', pos.coords.latitude, pos.coords.longitude);
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                        const idx = markers.indexOf(currentLocationMarker);
                        if (idx > -1) markers.splice(idx, 1);
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    currentLocationCoords = { lat: lat, lng: lng };

                    // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π –º–∞—Ä–∫–µ—Ä —Å—Ç–∞—Ä—Ç–∞ (–∑–µ–ª—ë–Ω—ã–π)
                    const m = L.marker([lat, lng], {
                        draggable: true,
                        icon: createColoredIcon('#4CAF50', 'start')
                    }).addTo(map);
                    const startInp = document.getElementById('start_addr');
                    m.bindTooltip('–°—Ç–∞—Ä—Ç: ' + ((startInp && startInp.value) ? startInp.value : '')).openTooltip();
                    markers.push(m);
                    currentLocationMarker = m;

                    // –ü—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∞–¥—Ä–µ—Å
                    m.on('dragend', function (e) {
                        const newLat = e.target.getLatLng().lat;
                        const newLng = e.target.getLatLng().lng;
                        updateAddressFromCoords(newLat, newLng, m);
                    });

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏
                    map.setView([lat, lng], 15);

                    // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                    updateAddressFromCoords(lat, lng, m);
                },
                function (err) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', err);
                    let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.';
                    if (err.code === 1) msg = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    else if (err.code === 2) msg = '–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                    else if (err.code === 3) msg = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.';
                    alert(msg);
                }
            );
        }
        function geoLocateEnd() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    endLocationCoords = { lat: lat, lng: lng };

                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ü–∞, –µ—Å–ª–∏ –±—ã–ª
                    if (endLocationMarker) {
                        map.removeLayer(endLocationMarker);
                        const idx = markers.indexOf(endLocationMarker);
                        if (idx > -1) markers.splice(idx, 1);
                    }

                    // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ü–∞ (–∫—Ä–∞—Å–Ω—ã–π)
                    const m = L.marker([lat, lng], {
                        draggable: true,
                        icon: createColoredIcon('#F44336', 'end')
                    }).addTo(map);

                    m.bindTooltip('–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞').openTooltip();
                    markers.push(m);
                    endLocationMarker = m;

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
                    map.setView([lat, lng], 15);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –≤ –ø–æ–ª–µ
                    fetch('/reverse_geocode?lat=' + lat + '&lng=' + lng)
                        .then(r => r.json())
                        .then(res => {
                            const inp = document.getElementById('end_addr');
                            if (inp) inp.value = res.address || '';
                            m.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + (res.address || ''));
                        });

                    // –ü—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
                    m.on('dragend', function (e) {
                        const p = e.target.getLatLng();

                        endLocationCoords = { lat: p.lat, lng: p.lng };

                        fetch('/reverse_geocode?lat=' + p.lat + '&lng=' + p.lng)
                            .then(r => r.json())
                            .then(res => {
                                const inp = document.getElementById('end_addr');
                                if (inp) inp.value = res.address || '';
                                m.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + (res.address || ''));
                            });
                    });

                },
                function (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.');
                }
            );
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.geoLocateStart = geoLocateStart;
        window.geoLocateEnd = geoLocateEnd;

        function updateMapMarkers() {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã, –∫—Ä–æ–º–µ –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –º–∞—Ä–∫–µ—Ä–∞ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏
            markers.forEach(m => {
                if (m !== currentLocationMarker && m !== endLocationMarker) {
                    map.removeLayer(m);
                }
            });
            // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω—É–∂–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            markers = [];
            if (currentLocationMarker) markers.push(currentLocationMarker);
            if (endLocationMarker) markers.push(endLocationMarker);

            // –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            const startInp = document.getElementById('start_addr');
            const endInp = document.getElementById('end_addr');

            // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ (–∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç)
            if (startInp && startInp.value) {
                // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –µ—â—ë –Ω–µ—Ç ‚Äî –∂–¥—ë–º geocodeStartAddress() –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ input/change
                if (currentLocationCoords && !currentLocationMarker) {
                    const startMarker = L.marker([currentLocationCoords.lat, currentLocationCoords.lng], {
                        draggable: true,
                        icon: createColoredIcon('#4CAF50', 'start')
                    }).addTo(map);

                    startMarker.bindTooltip('–°—Ç–∞—Ä—Ç: ' + startInp.value).openTooltip();

                    startMarker.on('dragend', function (e) {
                        const p = e.target.getLatLng();
                        updateAddressFromCoords(p.lat, p.lng, startMarker);
                        const latF = document.getElementById('start_lat');
                        const lngF = document.getElementById('start_lng');
                        if (latF) latF.value = p.lat;
                        if (lngF) lngF.value = p.lng;
                    });

                    markers.push(startMarker);
                    currentLocationMarker = startMarker;
                }

                if (currentLocationMarker) {
                    currentLocationMarker.setTooltipContent('–°—Ç–∞—Ä—Ç: ' + startInp.value);
                    if (currentLocationCoords) {
                        currentLocationMarker.setLatLng([currentLocationCoords.lat, currentLocationCoords.lng]);
                    }
                }
            }

            // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ (–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç)
            if (endInp && endInp.value) {
                if (!endLocationMarker) {
                    let lat, lon;
                    if (endLocationCoords) {
                        lat = endLocationCoords.lat;
                        lon = endLocationCoords.lng;
                    } else {
                        lat = 55.75 + Math.random() * 0.06 - 0.03;
                        lon = 37.61 + Math.random() * 0.09 - 0.045;
                    }

                    const endMarker = L.marker([lat, lon], {
                        draggable: true,
                        icon: createColoredIcon('#F44336', 'end')
                    }).addTo(map);
                    endMarker.bindTooltip('–ö–æ–Ω–µ—Ü: ' + endInp.value).openTooltip();

                    // –ü—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
                    endMarker.on('dragend', function (e) {
                        const p = e.target.getLatLng();

                        endLocationCoords = { lat: p.lat, lng: p.lng };

                        fetch('/reverse_geocode?lat=' + p.lat + '&lng=' + p.lng)
                            .then(r => r.json())
                            .then(res => {
                                const inp = document.getElementById('end_addr');
                                if (inp) inp.value = res.address || '';
                                endMarker.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + (res.address || ''));
                            });
                    });

                    markers.push(endMarker);
                    endLocationMarker = endMarker;
                } else {
                    // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–∏–º –ø–æ–¥–ø–∏—Å—å –∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    endLocationMarker.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + endInp.value);
                    if (endLocationCoords) {
                        endLocationMarker.setLatLng([endLocationCoords.lat, endLocationCoords.lng]);
                    }
                }
            }
        }

        document.getElementById('mainform').addEventListener('input', function (e) {
            setTimeout(updateMapMarkers, 200);
        });
        setTimeout(updateMapMarkers, 600);

        map.on('click', function (e) {
            let lat = e.latlng.lat, lng = e.latlng.lng;
            fetch('/reverse_geocode?lat=' + lat + '&lng=' + lng).then(
                r => r.json()).then(res => {
                    let end = document.getElementById('end_addr');
                    if (end && !end.value) end.value = res.address;
                    updateMapMarkers();
                });
        });

        let startGeocodeTimer = null;

        function geocodeStartAddress() {
            const startInp = document.getElementById('start_addr');
            if (!startInp) return;
            const q = (startInp.value || '').trim();
            if (!q) return;

            fetch('/geocode?query=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(res => {
                    if (!res || res.lat === null || res.lng === null) return;

                    currentLocationCoords = { lat: res.lat, lng: res.lng };
                    const latField = document.getElementById('start_lat');
                    const lngField = document.getElementById('start_lng');
                    if (latField) latField.value = res.lat;
                    if (lngField) lngField.value = res.lng;

                    if (!currentLocationMarker) {
                        currentLocationMarker = L.marker([res.lat, res.lng], {
                            draggable: true,
                            icon: createColoredIcon('#4CAF50', 'start')
                        }).addTo(map);
                        currentLocationMarker.bindTooltip('–°—Ç–∞—Ä—Ç: ' + q).openTooltip();
                        markers.push(currentLocationMarker);

                        currentLocationMarker.on('dragend', function (e) {
                            const p = e.target.getLatLng();
                            updateAddressFromCoords(p.lat, p.lng, currentLocationMarker);
                            const latF = document.getElementById('start_lat');
                            const lngF = document.getElementById('start_lng');
                            if (latF) latF.value = p.lat;
                            if (lngF) lngF.value = p.lng;
                        });
                    } else {
                        currentLocationMarker.setLatLng([res.lat, res.lng]);
                        currentLocationMarker.setTooltipContent('–°—Ç–∞—Ä—Ç: ' + q);
                        if (!map.hasLayer(currentLocationMarker)) currentLocationMarker.addTo(map);
                    }

                    map.setView([res.lat, res.lng], Math.max(map.getZoom(), 14));
                })
                .catch(() => { });
        }

        const startInpEl = document.getElementById('start_addr');
        if (startInpEl) {
            startInpEl.addEventListener('input', function () {
                clearTimeout(startGeocodeTimer);
                startGeocodeTimer = setTimeout(geocodeStartAddress, 600);
            });
            startInpEl.addEventListener('change', function () {
                clearTimeout(startGeocodeTimer);
                startGeocodeTimer = setTimeout(geocodeStartAddress, 10);
            });
        }

        let endGeocodeTimer = null;

        function geocodeEndAddress() {
            const endInp = document.getElementById('end_addr');
            if (!endInp) return;
            const q = (endInp.value || '').trim();
            if (!q) return;

            fetch('/geocode?query=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(res => {
                    if (!res || res.lat === null || res.lng === null) return;

                    endLocationCoords = { lat: res.lat, lng: res.lng };
                    const latField = document.getElementById('end_lat');
                    const lngField = document.getElementById('end_lng');
                    if (latField) latField.value = res.lat;
                    if (lngField) lngField.value = res.lng;

                    if (!endLocationMarker) {
                        endLocationMarker = L.marker([res.lat, res.lng], {
                            draggable: true,
                            icon: createColoredIcon('#F44336', 'end')
                        }).addTo(map);
                        endLocationMarker.bindTooltip('–ö–æ–Ω–µ—Ü: ' + q).openTooltip();
                        markers.push(endLocationMarker);

                        endLocationMarker.on('dragend', function (e) {
                            const p = e.target.getLatLng();

                            endLocationCoords = { lat: p.lat, lng: p.lng };

                            fetch('/reverse_geocode?lat=' + p.lat + '&lng=' + p.lng)
                                .then(r => r.json())
                                .then(res => {
                                    const inp = document.getElementById('end_addr');
                                    if (inp) inp.value = res.address || '';
                                    endLocationMarker.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + (res.address || ''));
                                });
                        });
                    } else {
                        endLocationMarker.setLatLng([res.lat, res.lng]);
                        endLocationMarker.setTooltipContent('–ö–æ–Ω–µ—Ü: ' + q);
                        if (!map.hasLayer(endLocationMarker)) endLocationMarker.addTo(map);
                    }

                    map.setView([res.lat, res.lng], Math.max(map.getZoom(), 14));
                })
                .catch(() => { });
        }

        const endInpEl = document.getElementById('end_addr');
        if (endInpEl) {
            endInpEl.addEventListener('input', function () {
                clearTimeout(endGeocodeTimer);
                endGeocodeTimer = setTimeout(geocodeEndAddress, 600);
            });
            endInpEl.addEventListener('change', function () {
                clearTimeout(endGeocodeTimer);
                endGeocodeTimer = setTimeout(geocodeEndAddress, 10);
            });
        }

        let routingControl = null;

        function drawRouteIfPossible() {
            const sLat = parseFloat(document.getElementById('start_lat')?.value || '');
            const sLng = parseFloat(document.getElementById('start_lng')?.value || '');
            const eLat = parseFloat(document.getElementById('end_lat')?.value || '');
            const eLng = parseFloat(document.getElementById('end_lng')?.value || '');
            if (![sLat, sLng, eLat, eLng].every(n => Number.isFinite(n))) return;

            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(sLat, sLng),
                    L.latLng(eLat, eLng)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                lineOptions: {
                    styles: [{ color: '#1e88e5', weight: 6, opacity: 0.8 }]
                },
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                show: false,
                createMarker: function () { return null; }
            }).addTo(map);
        }

        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ç–æ –µ—Å—Ç—å –ø–æ—Å–ª–µ POST) –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç
        setTimeout(() => {
            updateMapMarkers();
            if (IS_GENERATED) {
                drawRouteIfPossible();
            }
            addPlaceMarkersIfGenerated();
        }, 800);

        function editRoute() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('results').style.display = 'none';
        }
        // Sync budget slider & text
        window.budget_slider && budget_slider.addEventListener('input', () => budgetValInp.value = budget_slider.value);
        window.budgetValInp && budgetValInp.addEventListener('input', () => budget_slider.value = budgetValInp.value);
    </script>
</body>

</html>
